<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DYLARBOT Foot</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root{ --primary:#1B263B; --highlight:#D4AF37; --ok:#2E8B57; --danger:#8B0000; }
    body{font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#0b1320;color:#f2f2f2}
    .navbar{background:var(--primary)}
    .brand{color:var(--highlight);font-weight:700;text-decoration:none}
    .page{max-width:1100px;margin:auto;padding:24px}
    .cardx{background:#1f2a44;border:1px solid rgba(255,255,255,.06);border-radius:16px;box-shadow:0 6px 24px rgba(0,0,0,.35)}
    .cardx .card-header{border-bottom:1px solid rgba(255,255,255,.06)}
    .form-label{font-weight:600}
    .btn-primary{background:var(--ok);border:none}
    .btn-secondary{background:var(--danger);border:none}
    .badge-odds{background:#243150;border:1px solid rgba(255,255,255,.08)}
    .muted{opacity:.85}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
    .logo{width:48px;height:48px;object-fit:contain}
    .divider{height:1px;background:rgba(255,255,255,.08);margin:12px 0}
    .table{--bs-table-bg:transparent;color:#e8e8e8}
    .table>:not(caption)>*>*{border-bottom-color:rgba(255,255,255,.08)}
    .text-green{color:#7CFFB2}
    .text-yellow{color:#FFD166}
    .text-red{color:#FF6B6B}
    .small{font-size:.95rem}
    .code{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace}
    @media(max-width:768px){.grid-2,.grid-3{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <nav class="navbar navbar-expand">
    <div class="container-fluid">
      <a class="brand navbar-brand" href="/">DYLARBOT Foot</a>
    </div>
  </nav>

  <div class="page">
    <div class="cardx mb-4">
      <div class="card-header p-3">
        <h5 class="m-0"><i class="fa-solid fa-wand-magic-sparkles me-2"></i>Générer une prédiction</h5>
      </div>
      <div class="card-body p-4">
        <form method="POST" id="predictionForm">
          <div class="grid-2">
            <div>
              <label class="form-label" for="home_team">Équipe à domicile</label>
              <select id="home_team" name="home_team" class="form-select" required>
                <option value="">Choisir…</option>
                {% for t in teams %}
                  <option value="{{ t }}" {% if t==home_team %}selected{% endif %}>{{ t }}</option>
                {% endfor %}
              </select>
            </div>
            <div>
              <label class="form-label" for="away_team">Équipe à l'extérieur</label>
              <select id="away_team" name="away_team" class="form-select" required>
                <option value="">Choisir…</option>
                {% for t in teams %}
                  <option value="{{ t }}" {% if t==away_team %}selected{% endif %}>{{ t }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <details class="mt-3">
            <summary class="mb-2">Ajouter des cotes (facultatif) <span class="badge rounded-pill badge-odds ms-2">1 / X / 2</span></summary>
            <div class="grid-3 mt-2">
              <div>
                <label class="form-label small" for="odds_1">Cote 1</label>
                <input type="number" step="0.01" min="1.01" class="form-control" id="odds_1" name="odds_1" placeholder="ex: 1.85" value="{{ request.form.odds_1 or '' }}">
              </div>
              <div>
                <label class="form-label small" for="odds_x">Cote X</label>
                <input type="number" step="0.01" min="1.01" class="form-control" id="odds_x" name="odds_x" placeholder="ex: 3.40" value="{{ request.form.odds_x or '' }}">
              </div>
              <div>
                <label class="form-label small" for="odds_2">Cote 2</label>
                <input type="number" step="0.01" min="1.01" class="form-control" id="odds_2" name="odds_2" placeholder="ex: 4.20" value="{{ request.form.odds_2 or '' }}">
              </div>
            </div>
            <div class="form-text mt-2">Si vous renseignez les cotes, on calcule l’<span class="code">EV</span> et la mise de <span class="code">Kelly</span>.</div>
          </details>

          {% if error %}
            <div class="alert alert-danger mt-3"><i class="fa-solid fa-triangle-exclamation me-2"></i>{{ error }}</div>
          {% endif %}

          <div class="d-flex gap-2 mt-3">
            <button class="btn btn-primary w-50" type="submit"><i class="fa-solid fa-robot me-2"></i>Prédire</button>
            <a class="btn btn-secondary w-50" href="/"><i class="fa-solid fa-rotate me-2"></i>Réinitialiser</a>
          </div>
        </form>
      </div>
    </div>

    {% if predictions %}
      <div class="cardx">
        <div class="card-header p-3">
          <div class="d-flex align-items-center gap-3">
            {% if home_logo %}<img class="logo" src="{{ home_logo }}" alt="{{ home_team }}"/>{% endif %}
            <h5 class="m-0">{{ home_team }} <span class="muted">vs</span> {{ away_team }}</h5>
            {% if away_logo %}<img class="logo" src="{{ away_logo }}" alt="{{ away_team }}"/>{% endif %}
          </div>
        </div>

        <div class="card-body p-4">
          {% if predictions == 'no_data' %}
            <div class="alert alert-warning"><i class="fa-regular fa-circle-question me-2"></i>Pas assez de données récentes pour estimer ce match.</div>
          {% else %}
            {# Probas 1X2 arrondies #}
            {% set p1 = (predictions.probs['1'] * 100) | round(1) %}
            {% set px = (predictions.probs['X'] * 100) | round(1) %}
            {% set p2 = (predictions.probs['2'] * 100) | round(1) %}
            {% set best_key = '1' if p1 >= px and p1 >= p2 else ('X' if px >= p1 and px >= p2 else '2') %}
            {% set best_val = p1 if best_key=='1' else (px if best_key=='X' else p2) %}

            <div class="grid-3">
              <div class="p-3 rounded" style="background:#1b2540;border:1px solid rgba(255,255,255,.06)">
                <div class="text-uppercase small muted">1X2 le plus probable</div>
                <div class="fs-4 fw-semibold mt-1">
                  {{ best_key }} <span class="text-yellow">({{ '%.1f'|format(best_val) }}%)</span>
                </div>
                <div class="mt-2 small">1: {{ '%.1f'|format(p1) }}% &nbsp; | &nbsp; X: {{ '%.1f'|format(px) }}% &nbsp; | &nbsp; 2: {{ '%.1f'|format(p2) }}%</div>
              </div>

              <div class="p-3 rounded" style="background:#1b2540;border:1px solid rgba(255,255,255,.06)">
                <div class="text-uppercase small muted">Score le plus probable</div>
                <div class="fs-4 fw-semibold mt-1">
                  {% if predictions.most_likely_score %}
                    {{ predictions.most_likely_score[0] }} - {{ predictions.most_likely_score[1] }}
                  {% else %}—{% endif %}
                </div>
                <div class="mt-2 small">Modèle Poisson (lambdas issus des moyennes GS/GC).</div>
              </div>

              <div class="p-3 rounded" style="background:#1b2540;border:1px solid rgba(255,255,255,.06)">
                <div class="text-uppercase small muted">Over/Under & BTTS</div>
                <div class="mt-2 small">
                  Over 2.5 : {{ '%.1f'|format(predictions.probs['over25']*100) }}%<br/>
                  Under 2.5 : {{ '%.1f'|format(predictions.probs['under25']*100) }}%
                  <div class="divider"></div>
                  BTTS OUI : {{ '%.1f'|format(predictions.probs['btts_yes']*100) }}%<br/>
                  BTTS NON : {{ '%.1f'|format(predictions.probs['btts_no']*100) }}%
                </div>
              </div>
            </div>

            {# EV & Kelly si cotes fournies #}
            {% set ev1 = predictions.expected_value['1'] %}
            {% set evx = predictions.expected_value['X'] %}
            {% set ev2 = predictions.expected_value['2'] %}
            {% set k1  = predictions.kelly['1'] %}
            {% set kx  = predictions.kelly['X'] %}
            {% set k2  = predictions.kelly['2'] %}
            {% if ev1 is not none or evx is not none or ev2 is not none %}
              <div class="divider"></div>
              <h6 class="mb-3"><i class="fa-solid fa-scale-balanced me-2"></i>Value & Gestion de mise</h6>
              <div class="table-responsive">
                <table class="table align-middle">
                  <thead>
                    <tr>
                      <th>Marché</th>
                      <th>Probabilité modèle</th>
                      <th>EV (espérance)</th>
                      <th>Kelly (fraction)</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>1</td>
                      <td>{{ '%.1f'|format(p1) }}%</td>
                      <td class="{% if ev1 is not none and ev1>0 %}text-green{% elif ev1 is not none and ev1<0 %}text-red{% endif %}">
                        {{ ev1 is not none and ('%.4f'|format(ev1)) or '—' }}
                      </td>
                      <td>{{ k1 is not none and ('%.2f'|format(k1*100)) ~ '%' or '—' }}</td>
                    </tr>
                    <tr>
                      <td>X</td>
                      <td>{{ '%.1f'|format(px) }}%</td>
                      <td class="{% if evx is not none and evx>0 %}text-green{% elif evx is not none and evx<0 %}text-red{% endif %}">
                        {{ evx is not none and ('%.4f'|format(evx)) or '—' }}
                      </td>
                      <td>{{ kx is not none and ('%.2f'|format(kx*100)) ~ '%' or '—' }}</td>
                    </tr>
                    <tr>
                      <td>2</td>
                      <td>{{ '%.1f'|format(p2) }}%</td>
                      <td class="{% if ev2 is not none and ev2>0 %}text-green{% elif ev2 is not none and ev2<0 %}text-red{% endif %}">
                        {{ ev2 is not none and ('%.4f'|format(ev2)) or '—' }}
                      </td>
                      <td>{{ k2 is not none and ('%.2f'|format(k2*100)) ~ '%' or '—' }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div class="small muted">EV &gt; 0 ⇒ pari à valeur attendue positive. Kelly = fraction du capital à engager (version fractionnée pour limiter la variance).</div>
            {% endif %}

            {# Stats équipes issues de extract_team_stats (gs_avg/gc_avg) #}
            {% if home_stats and away_stats %}
              <div class="divider"></div>
              <h6 class="mb-2"><i class="fa-solid fa-chart-simple me-2"></i>Statistiques récentes</h6>
              <div class="grid-2">
                <div class="p-3 rounded" style="background:#1b2540;border:1px solid rgba(255,255,255,.06)">
                  <div class="small muted mb-1">{{ home_team }}</div>
                  <div>But(s) marqués/match : <strong>{{ '%.2f'|format(home_stats.gs_avg) }}</strong></div>
                  <div>But(s) encaissés/match : <strong>{{ '%.2f'|format(home_stats.gc_avg) }}</strong></div>
                </div>
                <div class="p-3 rounded" style="background:#1b2540;border:1px solid rgba(255,255,255,.06)">
                  <div class="small muted mb-1">{{ away_team }}</div>
                  <div>But(s) marqués/match : <strong>{{ '%.2f'|format(away_stats.gs_avg) }}</strong></div>
                  <div>But(s) encaissés/match : <strong>{{ '%.2f'|format(away_stats.gc_avg) }}</strong></div>
                </div>
              </div>
            {% endif %}
          {% endif %}
        </div>
      </div>
    {% endif %}
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
